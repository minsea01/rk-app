version: '3.8'

services:
  rk3588-detector:
    build:
      context: ../..
      dockerfile: docker/rk3588-runtime.Dockerfile
    image: rk3588-person-detector:latest

    # 使用主机网络（双网卡直接访问）
    network_mode: host

    # NPU 设备访问
    devices:
      - /dev/dri:/dev/dri           # GPU/NPU 设备
      - /dev/mali0:/dev/mali0       # Mali GPU（如果需要）

    # 最小权限：DMA-BUF pinned memory + raw device I/O（替代 privileged: true）
    cap_add:
      - IPC_LOCK    # DMA-BUF mmap pinned memory
      - SYS_RAWIO   # NPU/DRI raw device access
    security_opt:
      - no-new-privileges:true

    # 挂载 RKNN 运行时库（如果主机已安装）
    volumes:
      - /usr/lib/aarch64-linux-gnu/librknpu.so:/usr/lib/aarch64-linux-gnu/librknpu.so:ro
      - /opt/rknpu2:/opt/rknpu2:ro
      - ../../artifacts:/app/artifacts
      - ../../logs:/app/logs

    # 环境变量
    environment:
      - PYTHONPATH=/app
      - LD_LIBRARY_PATH=/opt/rknpu2/lib

    # 启动命令
    command: >
      python3 apps/yolov8_rknn_infer.py
      --model /app/artifacts/models/best.rknn
      --source /app/assets/test.jpg
      --output /app/logs/result.json

    # 资源限制
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
