# RK3588 Network Performance Tuning
# 用途：优化双千兆网口性能，支持≥900Mbps吞吐量
# 部署位置：/etc/sysctl.d/99-rk3588-network-performance.conf
# 应用方法：sudo sysctl -p /etc/sysctl.d/99-rk3588-network-performance.conf

# ====================================================================
# 核心网络缓冲区配置
# ====================================================================

# 接收缓冲区最大值（256MB）
# 用于高带宽场景（2K@30fps工业相机数据流）
net.core.rmem_max = 268435456

# 发送缓冲区最大值（256MB）
# 用于检测结果快速上传
net.core.wmem_max = 268435456

# 接收缓冲区默认值（16MB）
net.core.rmem_default = 16777216

# 发送缓冲区默认值（16MB）
net.core.wmem_default = 16777216

# 网络设备接收队列长度
# 高吞吐量场景下防止丢包
net.core.netdev_max_backlog = 10000

# 网络设备发送队列长度
net.core.netdev_budget = 600

# ====================================================================
# TCP协议栈优化
# ====================================================================

# TCP接收缓冲区（最小值、默认值、最大值）
# 格式：min default max（字节）
net.ipv4.tcp_rmem = 4096 87380 134217728

# TCP发送缓冲区（最小值、默认值、最大值）
net.ipv4.tcp_wmem = 4096 65536 134217728

# TCP拥塞控制算法：BBR（推荐用于高带宽低延迟场景）
# 备选：cubic（默认）, htcp, vegas
net.ipv4.tcp_congestion_control = bbr

# 启用TCP窗口缩放（支持高带宽延迟积网络）
net.ipv4.tcp_window_scaling = 1

# 启用TCP时间戳（用于RTT估算）
net.ipv4.tcp_timestamps = 1

# 启用TCP选择性确认（SACK）
net.ipv4.tcp_sack = 1

# TCP最大SYN积压队列
net.ipv4.tcp_max_syn_backlog = 8192

# TCP Keepalive探测间隔（秒）
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 5

# ====================================================================
# UDP协议栈优化
# ====================================================================

# UDP接收缓冲区大小
net.ipv4.udp_rmem_min = 131072
net.ipv4.udp_wmem_min = 131072

# ====================================================================
# IP层优化
# ====================================================================

# IP转发（如果需要路由功能）
# 工业相机网络（eth0）到结果上传网络（eth1）的转发
net.ipv4.ip_forward = 0

# 允许非本地IP绑定（用于iperf3测试）
net.ipv4.ip_nonlocal_bind = 1

# 路由缓存优化
net.ipv4.route.max_size = 2147483647

# ====================================================================
# 网络接口队列优化
# ====================================================================

# 启用接收包控制（RPS）- 将接收处理分散到多核
# 注意：需要配合 /sys/class/net/*/queues/rx-*/rps_cpus 使用

# 启用接收流控制（RFS）
net.core.rps_sock_flow_entries = 32768

# ====================================================================
# 内存管理
# ====================================================================

# 降低swap使用（嵌入式系统推荐）
vm.swappiness = 10

# 脏页写回阈值（适合实时系统）
vm.dirty_ratio = 10
vm.dirty_background_ratio = 5

# ====================================================================
# 双千兆网口特定优化
# ====================================================================

# ARP缓存大小（大型网络环境）
net.ipv4.neigh.default.gc_thresh1 = 1024
net.ipv4.neigh.default.gc_thresh2 = 4096
net.ipv4.neigh.default.gc_thresh3 = 8192

# 连接跟踪表大小（如果使用防火墙）
net.netfilter.nf_conntrack_max = 524288

# ====================================================================
# 性能监控相关
# ====================================================================

# 启用详细的网络统计
net.core.netdev_tstamp_prequeue = 0

# ====================================================================
# RK3588特定优化建议
# ====================================================================
#
# 1. CPU中断亲和性（手动配置，不在sysctl中）：
#    echo "30" > /proc/irq/<eth0_irq>/smp_affinity  # CPU 4-5 (A76)
#    echo "C0" > /proc/irq/<eth1_irq>/smp_affinity  # CPU 6-7 (A76)
#
# 2. 网卡队列长度（使用ethtool）：
#    ethtool -G eth0 rx 4096 tx 4096
#    ethtool -G eth1 rx 2048 tx 2048
#
# 3. 硬件offload（使用ethtool）：
#    ethtool -K eth0 tso on gso on gro on
#    ethtool -K eth1 tso on gso on gro on
#
# 4. MTU设置（巨型帧，如果网络支持）：
#    ip link set eth0 mtu 9000
#    ip link set eth1 mtu 9000
#
# ====================================================================

# 配置说明：
# - 此配置针对RK3588双千兆网口优化，目标吞吐量≥900Mbps
# - 适用场景：工业相机数据采集 + AI检测结果上传
# - 网口1（eth0）：2K@30fps相机数据流（~248Mbps实际带宽）
# - 网口2（eth1）：检测结果JSON上传（~10-50Mbps）
# - 系统要求：Ubuntu 20.04/22.04, Linux 5.10+
#
# 验证方法：
#   sudo sysctl -p /etc/sysctl.d/99-rk3588-network-performance.conf
#   iperf3 -c <server> -t 60 -w 4M -P 4
#
# 作者：RK3588行人检测项目
# 日期：2025-11-19
# 参考：Linux Kernel Documentation - networking/ip-sysctl.txt
