name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop, claude/** ]
  pull_request:
    branches: [ main, master, develop ]

env:
  PYTHON_VERSION: '3.10'

jobs:
  # Python code quality - simplified
  python-quality:
    name: Python Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black flake8

      - name: Check code formatting with black
        run: black --check apps/ tools/ tests/

      - name: Lint with flake8 (critical errors only)
        run: flake8 apps/ tools/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics

  # Python unit tests - simplified
  python-tests:
    name: Python Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10']
      fail-fast: false
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy opencv-python-headless pillow PyYAML pytest pytest-cov

      - name: Run tests (skip hardware-dependent)
        run: |
          export PYTHONPATH=$PWD
          pytest tests/unit/ -v -m "not requires_hardware"

  # File validation
  file-validation:
    name: Validate Project Files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Check critical files exist
        run: |
          echo "Checking critical files..."
          test -f apps/config.py && echo "✓ apps/config.py exists"
          test -f apps/exceptions.py && echo "✓ apps/exceptions.py exists"
          test -f apps/logger.py && echo "✓ apps/logger.py exists"
          test -f tools/convert_onnx_to_rknn.py && echo "✓ tools/convert_onnx_to_rknn.py exists"
          test -f scripts/network/rgmii_driver_config.sh && echo "✓ RGMII script exists"
          test -f scripts/network/network_throughput_validator.sh && echo "✓ Network validator exists"
          test -f scripts/evaluation/pedestrian_map_evaluator.py && echo "✓ mAP evaluator exists"
          test -f scripts/profiling/performance_profiler.py && echo "✓ Performance profiler exists"
          test -f Dockerfile && echo "✓ Dockerfile exists"
          echo "All critical files present!"

      - name: Check script permissions
        run: |
          echo "Checking script permissions..."
          test -x scripts/network/rgmii_driver_config.sh && echo "✓ RGMII script executable"
          test -x scripts/network/network_throughput_validator.sh && echo "✓ Network validator executable"
          test -x scripts/evaluation/pedestrian_map_evaluator.py && echo "✓ mAP evaluator executable"
          test -x scripts/profiling/performance_profiler.py && echo "✓ Performance profiler executable"
          echo "All scripts are executable!"

      - name: Validate shell scripts
        run: |
          sudo apt-get update && sudo apt-get install -y shellcheck
          find scripts/ -name "*.sh" -type f | while read script; do
            echo "Checking $script..."
            shellcheck -S error "$script"
          done

  redundancy-check:
    name: Redundancy Guardrails
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install ripgrep
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: Run redundancy checks
        run: |
          chmod +x scripts/check_redundancy.sh
          ./scripts/check_redundancy.sh

      - name: Verify generated requirements
        run: |
          python3 tools/export_requirements.py --check

  cpp-build-tests:
    name: C++ Build and Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install C++ dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build pkg-config libopencv-dev libyaml-cpp-dev

      - name: Configure (x86 debug)
        run: cmake --preset x86-debug -DENABLE_ONNX=OFF

      - name: Build (x86 debug)
        run: cmake --build --preset x86-debug

      - name: Run CTest
        run: ctest --preset x86-debug

  # Model files validation
  model-validation:
    name: Model Files Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Check model files
        run: |
          echo "Checking model files..."
          if [ -f artifacts/models/best.onnx ]; then
            echo "✓ best.onnx exists ($(du -h artifacts/models/best.onnx | cut -f1))"
          fi
          if [ -f artifacts/models/best.rknn ]; then
            echo "✓ best.rknn exists ($(du -h artifacts/models/best.rknn | cut -f1))"
          fi
          if [ -f artifacts/models/yolo11n.onnx ]; then
            echo "✓ yolo11n.onnx exists ($(du -h artifacts/models/yolo11n.onnx | cut -f1))"
          fi
          echo "Model files check complete"

  # Documentation check
  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Check documentation files
        run: |
          echo "Checking documentation..."
          test -f CLAUDE.md && echo "✓ CLAUDE.md exists"
          test -f README.md && echo "✓ README.md exists"
          test -f docs/reports/S_LEVEL_COMPLETION_REPORT.md && echo "✓ S-level report exists"
          test -f docs/reports/HONEST_ENGINEERING_ASSESSMENT.md && echo "✓ Honest assessment exists"
          test -f docs/reports/TASK_REQUIREMENTS_ASSESSMENT.md && echo "✓ Task assessment exists"

          echo ""
          echo "Documentation statistics:"
          find docs/ -name "*.md" -type f | wc -l | xargs echo "Markdown files:"
          find docs/ -name "*.docx" -type f | wc -l | xargs echo "Word documents:"

  # Project statistics
  project-stats:
    name: Project Statistics
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Calculate code statistics
        run: |
          echo "=== Project Statistics ==="
          echo ""
          echo "Python code:"
          find apps/ tools/ -name "*.py" -type f | wc -l | xargs echo "  Files:"
          find apps/ tools/ -name "*.py" -type f -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print "  Lines: " $1}'

          echo ""
          echo "C++ code:"
          find src/ -name "*.cpp" -o -name "*.hpp" -o -name "*.h" 2>/dev/null | wc -l | xargs echo "  Files:"
          find src/ -name "*.cpp" -o -name "*.hpp" 2>/dev/null -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print "  Lines: " $1}' || echo "  Lines: N/A"

          echo ""
          echo "Test code:"
          find tests/ -name "*.py" -o -name "*.cpp" 2>/dev/null | wc -l | xargs echo "  Files:"
          find tests/ -name "*.py" -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print "  Lines: " $1}' || echo "  Lines: N/A"

          echo ""
          echo "Shell scripts:"
          find scripts/ -name "*.sh" -type f | wc -l | xargs echo "  Files:"

          echo ""
          echo "Documentation:"
          find docs/ -name "*.md" -type f -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print "  MD lines: " $1}'

  # CI Success
  ci-success:
    name: CI Pipeline Complete
    needs: [python-quality, python-tests, file-validation, redundancy-check, model-validation, docs-check, project-stats, cpp-build-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check CI status
        run: |
          statuses=(
            "python-quality=${{ needs['python-quality'].result }}"
            "python-tests=${{ needs['python-tests'].result }}"
            "file-validation=${{ needs['file-validation'].result }}"
            "redundancy-check=${{ needs['redundancy-check'].result }}"
            "model-validation=${{ needs['model-validation'].result }}"
            "docs-check=${{ needs['docs-check'].result }}"
            "project-stats=${{ needs['project-stats'].result }}"
            "cpp-build-tests=${{ needs['cpp-build-tests'].result }}"
          )

          failed=0
          for status in "${statuses[@]}"; do
            echo "$status"
            if [[ "$status" != *=success ]]; then
              failed=1
            fi
          done

          if [[ "$failed" -ne 0 ]]; then
            echo "CI gate failed: at least one required job did not succeed"
            exit 1
          fi

          echo "CI gate passed: all required jobs succeeded"
